<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>poste.ar · ciudadela</title>
    <meta name="description" content="Red social anónima con identidad persistente. Sin registro, sin IPs, sin datos guardados. Todo se borra cada lunes.">
    <meta name="keywords" content="red social anónima, mensajes criptografiados, cifrado AES-256, comunicación anónima, poste.ar, Ciudadela">
    <meta name="author" content="poste.ar">
    <meta name="robots" content="index, follow">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://poste.ar/">
    <meta property="og:title" content="poste.ar · ciudadela">
    <meta property="og:description" content="Red social anónima con identidad persistente. Sin registro, sin IPs, sin datos guardados. Todo se borra cada lunes.">
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://poste.ar/">
    <meta property="twitter:title" content="poste.ar · ciudadela">
    <meta property="twitter:description" content="Red social anónima con identidad persistente. Sin registro, sin IPs, sin datos guardados. Todo se borra cada lunes.">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" id="theme-stylesheet" href="themes/default.css">
    <link rel="stylesheet" href="themes/mobile.css">
    <style>
        .header-profile { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
        .header-profile img { width: 60px; height: 60px; flex-shrink: 0; }
        .header-profile-info { flex: 1; }
        .button-container { display: flex; justify-content: space-between; gap: 10px; margin-top: 15px; }
        .button-group { display: flex; gap: 10px; }
        @media (hover: hover) {
            .btn:hover, .btn-volver:hover {
                background: rgba(0, 0, 0, 0.05) !important;
                transition: background 0.2s ease;
            }
            body.modo-noche .btn:hover,
            body.modo-noche .btn-volver:hover {
                background: rgba(255, 255, 255, 0.08) !important;
            }
            .btn-postear:hover {
                filter: brightness(1.1);
                transition: filter 0.2s ease;
            }
            body.modo-noche .btn-postear:hover {
                background: rgba(128, 128, 128, 0.3) !important;
                filter: none;
            }
        }
        .editor-section { margin-top: 20px; }
        .checkbox-label { cursor: pointer; font-size: 15px; }
        .checkbox-container { margin-top: 10px; }
        .password-section { margin-top: 10px; }
        .password-label { font-size: 15px; color: var(--color-secundario); margin-bottom: 5px; }
        .password-hint { font-size: 13px; color: var(--color-terciario); margin-top: 5px; }
        .bottom-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px; }
        .hidden { display: none !important; }
        .mensaje-oculto-item { border-left: 11px solid; padding-left: 8px; margin-top: 8px; padding-top: 6px; padding-bottom: 6px; }
        .mensaje-oculto-item:not(:last-child) { border-bottom: 1px solid rgba(128, 128, 128, 0.15); padding-bottom: 8px; }
        .mensaje-oculto-etiqueta { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .mensaje-oculto-texto { font-size: 14px; line-height: 1.4; }
        .login-section { padding: 0; background: transparent; margin-bottom: 20px; }
        .login-input { width: 100%; padding: 10px; font-size: 15px; border: 1px solid #d0d0d0; border-radius: 0; margin-bottom: 10px; background: var(--color-fondo); color: var(--color-principal); box-sizing: border-box; }
        .login-input:focus { outline: none; border: 1px solid #d0d0d0; background: rgba(0,0,0,0.02); }
        body.modo-noche .login-input:focus { background: rgba(255,255,255,0.02); }
        .login-input::placeholder { color: var(--color-terciario); opacity: 0.6; }
        .login-hint { font-size: 13px; color: var(--color-terciario); margin-bottom: 10px; line-height: 1.5; background: #f5f5f5; padding: 12px; border: 1px solid #e0e0e0; }
        body.modo-noche .login-hint { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .login-error { font-size: 13px; color: #dc3545; background: rgba(220, 53, 69, 0.1); padding: 10px; margin-bottom: 10px; border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 4px; }
        .login-checkboxes { display: flex; gap: 20px; margin-bottom: 10px; }
        .login-checkbox-label { font-size: 14px; color: var(--color-principal); cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .login-checkbox-label input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .login-usuario-guardado { font-size: 13px; color: var(--color-secundario); background: #f5f5f5; padding: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0; border-radius: 4px; }
        .login-usuario-guardado span { color: var(--rastro-color); font-weight: 600; }
        body.modo-noche .login-usuario-guardado { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .user-info-bar { font-size: 14px; color: var(--color-secundario); padding: 10px 0; margin: 15px 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; }
        body.modo-noche .user-info-bar { border-color: rgba(255,255,255,0.1); }
        .btn-salir { background: #dc3545; color: white; border: none; padding: 8px 15px; font-size: 15px; font-weight: normal; cursor: pointer; }
        .btn-salir:hover { background: #c82333; }
        .btn-modo-app { background: #28a745; color: white; border: none; padding: 8px 15px; font-size: 15px; font-weight: normal; cursor: pointer; }
        .btn-modo-app:hover { background: #218838; }
        .semilla-global-section { margin-top: 15px; padding: 15px; background: #f5f5f5; border: 1px solid #e0e0e0; }
        body.modo-noche .semilla-global-section { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .semilla-global-label { font-size: 14px; color: var(--color-secundario); margin-bottom: 8px; font-weight: 600; }
        .semilla-global-input { width: 100%; padding: 10px; font-size: 15px; border: 1px solid #d0d0d0; background: var(--color-fondo); color: var(--color-principal); box-sizing: border-box; }
        .semilla-global-input:focus { outline: none; border: 1px solid #d0d0d0; background: rgba(0,0,0,0.02); }
        body.modo-noche .semilla-global-input:focus { background: rgba(255,255,255,0.02); }
        .semilla-global-hint { font-size: 12px; color: var(--color-terciario); margin-top: 5px; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="header-profile">
            <img src="postear.gif" alt="logo">
            <div class="header-profile-info">
                <div class="brand-line">poste.ar</div>
                <div class="sub-brand">Sitio anónimo, efímero. Ciudadela, Buenos Aires, Argentina.</div>
            </div>
        </div>
        <div class="alerta-box hidden" id="contador-reset">El timeline se borra todos los lunes: calculando...</div>
        <div id="login-section" class="login-section">
            <div class="login-hint">
                Tu usuario se genera automáticamente a partir de tus palabras clave (semillas). Es un tipo contraseña usada en criptografia que recordás fácilmente. Mientras uses las mismas palabras, tendrás siempre el mismo usuario. Recomendamos usar entre 4 y 5 palabras simples (ejemplo: gato verde mesa tiza). Podés usar hasta 12 palabras para mayor seguridad. Ver manual para más detalles.
            </div>
            <div class="login-error hidden" id="login-error">Password equivocado</div>
            <input type="text" id="identity-input" class="login-input" placeholder="perro mesa luz golf" onkeypress="if(event.key==='Enter') entrar()">
            <div class="login-checkboxes">
                <label class="login-checkbox-label">
                    <input type="checkbox" id="checkbox-recordar-usuario"> Recordar usuario
                </label>
                <label class="login-checkbox-label">
                    <input type="checkbox" id="checkbox-recordar-password"> Recordar password
                </label>
            </div>
            <div class="login-usuario-guardado hidden" id="login-usuario-guardado">
                Usuario guardado: <span id="usuario-guardado-display"></span>
            </div>
            <button class="btn-postear" onclick="entrar()">[ entrar ]</button>
        </div>
        <div id="main-content" class="hidden">
            <div class="button-container">
                <button class="btn" onclick="toggleDiaNoche()" id="btn-modo">[ día ]</button>
                <button class="btn" onclick="toggleManual()">[ manual ]</button>
                <button class="btn" onclick="cambiarTema()" id="btn-tema">[ default ]</button>
                <button class="btn" onclick="window.open('/source')">[ source ]</button>
                <button class="btn-modo-app" onclick="toggleModoApp()" id="btn-modo-app">[ público ]</button>
            </div>
            <input type="text" class="search-box" id="search-input" placeholder="Buscar..." onkeyup="buscarConDelay()">
            <div class="search-info" id="search-info"></div>
            <button class="btn-volver hidden" id="btn-volver" onclick="volverATodos()">[ volver ]</button>
            <div class="user-info-bar">
                Tu usuario: <span id="display-user" style="color:var(--rastro-color); font-weight: 600;">...</span>
            </div>
            <div id="manual-box"></div>
            <div class="editor-section" id="editor-publico-section">
                <textarea id="editor" maxlength="576" placeholder="Mensaje público..."></textarea>
                <div class="contador" id="char-count">576 caracteres restantes</div>
                <div class="button-container button-container-bottom">
                    <button class="btn-postear" onclick="validarYPostear()">[ postear ]</button>
                    <button class="btn" onclick="actualizarPosts()">[ actualizar ]</button>
                    <button class="btn-salir" onclick="salir()">[ salir ]</button>
                </div>
            </div>
            <div class="editor-section hidden" id="editor-encriptado-section">
                <textarea id="editor-encriptado" maxlength="288" placeholder="Mensaje cifrado..."></textarea>
                <div class="contador" id="char-count-encriptado">288 caracteres restantes</div>
                <div class="password-section">
                    <div class="password-label">Semilla (obligatoria):</div>
                    <input type="text" id="password-encriptado-input" placeholder="Ejemplo: perro tiza golf maria" class="password-input">
                    <div class="password-hint">1-12 palabras. Más palabras = más seguridad.</div>
                </div>
                <div class="button-container button-container-bottom">
                    <button class="btn-postear" onclick="postearEncriptado()">[ postear ]</button>
                    <button class="btn" onclick="actualizarPosts()">[ actualizar ]</button>
                    <button class="btn-salir" onclick="salir()">[ salir ]</button>
                </div>
                <div id="semilla-leer-section" class="semilla-global-section" style="margin-top: 20px;">
                    <div class="semilla-global-label">Leer mensajes cifrados:</div>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <input type="text" id="semilla-leer-input" class="semilla-global-input" placeholder="Ingresá palabras semilla..." onkeypress="if(event.key==='Enter') leerMensajesCifrados()" style="flex: 1;">
                        <button class="btn" onclick="leerMensajesCifrados()" style="background: #17a2b8; color: white; min-width: 80px;">[ leer ]</button>
                    </div>
                    <label class="login-checkbox-label">
                        <input type="checkbox" id="checkbox-mantener-semilla"> Mantener semillas
                    </label>
                </div>
            </div>
        </div>
    </header>
    <div id="timeline"></div>
</div>
<script>
    let miMarca = "";
    let miColor = "";
    let buscando = false;
    let timeoutBusqueda = null;
    let todosLosPosts = [];
    let temas = ['default', 'retro', 'minimo', 'ascii'];
    let temaActual = localStorage.getItem('tema') || 'default';
    let modoOscuro = localStorage.getItem('modo') === 'noche';
    let modoApp = 'publico';
    let semillaGlobalActiva = '';
    async function cargarListaTemas() {
        try {
            const response = await fetch('/api/temas');
            if (response.ok) {
                const temasDisponibles = await response.json();
                const temasFiltrados = temasDisponibles.filter(t => t !== 'mobile');
                if (temasFiltrados.length > 0) {
                    temas = temasFiltrados;
                }
            }
        } catch(e) {
            console.log('Usando lista de temas por defecto');
        }
        if (!temas.includes(temaActual)) {
            temaActual = 'default';
            localStorage.setItem('tema', temaActual);
        }
    }
    function cargarTema() {
        const link = document.getElementById('theme-stylesheet');
        link.href = `themes/${temaActual}.css`;
        const btnTema = document.getElementById('btn-tema');
        if(btnTema) {
            btnTema.innerText = `[ ${temaActual} ]`;
        }
        if(modoOscuro) {
            document.body.classList.add('modo-noche');
            const btnModo = document.getElementById('btn-modo');
            if(btnModo) btnModo.innerText = '[ noche ]';
        } else {
            document.body.classList.remove('modo-noche');
            const btnModo = document.getElementById('btn-modo');
            if(btnModo) btnModo.innerText = '[ día ]';
        }
    }
    function cambiarTema() {
        const indiceActual = temas.indexOf(temaActual);
        const siguienteIndice = (indiceActual + 1) % temas.length;
        temaActual = temas[siguienteIndice];
        localStorage.setItem('tema', temaActual);
        cargarTema();
    }
    function toggleDiaNoche() {
        modoOscuro = !modoOscuro;
        localStorage.setItem('modo', modoOscuro ? 'noche' : 'dia');
        cargarTema();
    }
    function toggleModoApp() {
        if(modoApp === 'publico') {
            modoApp = 'encriptado';
            document.getElementById('btn-modo-app').innerText = '[ encriptado ]';
            document.getElementById('editor-publico-section').classList.add('hidden');
            document.getElementById('editor-encriptado-section').classList.remove('hidden');
            document.getElementById('search-input').classList.add('hidden');
            document.getElementById('search-info').classList.add('hidden');
            document.getElementById('btn-volver').classList.add('hidden');
            document.getElementById('timeline').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--color-terciario);">Ingresá una semilla para ver mensajes cifrados.</div>';
            semillaGlobalActiva = '';
        } else {
            modoApp = 'publico';
            document.getElementById('btn-modo-app').innerText = '[ público ]';
            document.getElementById('editor-publico-section').classList.remove('hidden');
            document.getElementById('editor-encriptado-section').classList.add('hidden');
            document.getElementById('search-input').classList.remove('hidden');
            document.getElementById('semilla-leer-input').value = '';
            document.getElementById('checkbox-mantener-semilla').checked = false;
            semillaGlobalActiva = '';
            cargarTimeline();
        }
    }
    function generarUsuarioDesdeIdentidad(identidad) {
        const hash = CryptoJS.SHA256(identidad).toString();
        const silabas = ['ba','be','bi','bo','bu','ca','ce','ci','co','cu','da','de','di','do','du','fa','fe','fi','fo','fu','ga','ge','gi','go','gu','ja','je','ji','jo','ju','ka','ke','ki','ko','ku','la','le','li','lo','lu','ma','me','mi','mo','mu','na','ne','ni','no','nu','pa','pe','pi','po','pu','ra','re','ri','ro','ru','sa','se','si','so','su','ta','te','ti','to','tu','va','ve','vi','vo','vu','xa','xe','xi','xo','xu','ya','ye','yi','yo','yu','za','ze','zi','zo','zu'];
        const idx1 = parseInt(hash.substring(0, 8), 16) % silabas.length;
        const num1 = parseInt(hash.substring(8, 16), 16) % 90 + 10;
        const idx2 = parseInt(hash.substring(16, 24), 16) % silabas.length;
        const num2 = parseInt(hash.substring(24, 32), 16) % 90 + 10;
        return `${silabas[idx1]}${silabas[idx2]}.${num1}@${silabas[(idx1+idx2)%silabas.length]}${silabas[(num1+num2)%silabas.length]}.${num2}`;
    }
    function generarColorDesdeIdentidad(identidad) {
        const hash = CryptoJS.SHA256(identidad).toString();
        const hue = parseInt(hash.substring(0, 8), 16) % 360;
        return `hsl(${hue}, 60%, 45%)`;
    }
    function entrar() {
        let identidad = document.getElementById('identity-input').value.trim();
        const recordarUsuario = document.getElementById('checkbox-recordar-usuario').checked;
        const recordarPassword = document.getElementById('checkbox-recordar-password').checked;
        const loginError = document.getElementById('login-error');
        const passwordGuardado = localStorage.getItem('password-guardado');
        loginError.classList.add('hidden');
        if(!recordarUsuario) {
            localStorage.removeItem('usuario-guardado');
        }
        if(!recordarPassword) {
            localStorage.removeItem('password-guardado');
        }
        if(recordarPassword && passwordGuardado && !identidad) {
            identidad = passwordGuardado;
        }
        if(!identidad) {
            alert('Ingresá al menos 3 palabras para crear tu identidad');
            return;
        }
        const palabras = identidad.split(/\s+/);
        if(palabras.length < 3 || palabras.length > 12) {
            alert('Usá entre 3 y 12 palabras');
            return;
        }
        const usuarioGuardado = localStorage.getItem('usuario-guardado');
        if(usuarioGuardado) {
            const usuarioIngresado = generarUsuarioDesdeIdentidad(identidad);
            if(usuarioIngresado !== usuarioGuardado) {
                loginError.classList.remove('hidden');
                return;
            }
        }
        sessionStorage.setItem('identidad', identidad);
        miMarca = generarUsuarioDesdeIdentidad(identidad);
        miColor = generarColorDesdeIdentidad(identidad);
        if(recordarUsuario) {
            localStorage.setItem('usuario-guardado', miMarca);
        }
        if(recordarPassword) {
            localStorage.setItem('password-guardado', identidad);
        }
        document.documentElement.style.setProperty('--rastro-color', miColor);
        document.getElementById('display-user').innerText = miMarca;
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('contador-reset').classList.remove('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        cargarTimeline();
    }
    function salir() {
        sessionStorage.removeItem('identidad');
        miMarca = "";
        miColor = "";
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('contador-reset').classList.add('hidden');
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('identity-input').value = '';
        document.getElementById('timeline').innerHTML = '';
        document.getElementById('login-error').classList.add('hidden');
        modoApp = 'publico';
        semillaGlobalActiva = '';
        cargarPreferenciasLogin();
    }
    function cargarPreferenciasLogin() {
        const usuarioGuardado = localStorage.getItem('usuario-guardado');
        const passwordGuardado = localStorage.getItem('password-guardado');
        const usuarioDisplay = document.getElementById('login-usuario-guardado');
        const usuarioGuardadoSpan = document.getElementById('usuario-guardado-display');
        if(usuarioGuardado) {
            document.getElementById('checkbox-recordar-usuario').checked = true;
            usuarioDisplay.classList.remove('hidden');
            usuarioGuardadoSpan.innerText = usuarioGuardado;
        } else {
            document.getElementById('checkbox-recordar-usuario').checked = false;
            usuarioDisplay.classList.add('hidden');
        }
        if(passwordGuardado) {
            document.getElementById('checkbox-recordar-password').checked = true;
        } else {
            document.getElementById('checkbox-recordar-password').checked = false;
        }
    }
    function verificarSesion() {
        const identidad = sessionStorage.getItem('identidad');
        if(identidad) {
            miMarca = generarUsuarioDesdeIdentidad(identidad);
            miColor = generarColorDesdeIdentidad(identidad);
            document.documentElement.style.setProperty('--rastro-color', miColor);
            document.getElementById('display-user').innerText = miMarca;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('contador-reset').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            cargarTimeline();
        } else {
            cargarPreferenciasLogin();
        }
    }
    function toggleManual() {
        const manualBox = document.getElementById('manual-box');
        if(manualBox.innerHTML === '') {
            manualBox.innerHTML = `MANUAL DE USO - poste.ar

IDENTIDAD
Tu usuario se genera automáticamente con palabras semilla.
Ejemplo: "gato verde mesa tiza" → siempre genera el mismo usuario.
Recomendamos 4-5 palabras simples. Máximo 12 palabras.

MODO PÚBLICO
- Timeline abierto visible para todos.
- Posteos sin cifrado.
- Mensajes públicos permanentes hasta el lunes.

MODO ENCRIPTADO
- Timeline cifrado independiente.
- Ingresá semillas para descifrar mensajes.
- Solo ves mensajes de tu grupo cifrado.
- Posteos cifrados sin huella pública.

PRIVACIDAD
- No guardamos IPs ni datos personales.
- El servidor no conoce tus claves.
- Todo se cifra/descifra en tu navegador.
- Timeline se borra cada lunes.

BÚSQUEDA (solo en modo público)
Buscá por texto o hashtags.
Ejemplo: #ciudadela

TEMAS
Cambiá el aspecto visual del sitio.`;
        } else {
            manualBox.innerHTML = '';
        }
    }
    function actualizarContadorReset() {
        const ahora = new Date();
        const diaSemana = ahora.getDay();
        const diasHastaLunes = diaSemana === 0 ? 1 : (8 - diaSemana) % 7;
        const proximoLunes = new Date(ahora);
        proximoLunes.setDate(ahora.getDate() + diasHastaLunes);
        proximoLunes.setHours(0, 0, 0, 0);
        const diff = proximoLunes - ahora;
        const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
        const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        let texto = "El timeline se borra todos los lunes: ";
        if(dias > 0) texto += `${dias}d `;
        texto += `${horas}h ${minutos}m`;
        const contador = document.getElementById('contador-reset');
        if(contador) contador.innerText = texto;
    }
    async function cargarTimeline() {
        if(modoApp === 'encriptado') return;
        try {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            console.log('Posts recibidos:', posts.length);
            console.log('Primeros 3 posts:', posts.slice(0, 3));
            todosLosPosts = posts;
            mostrarPosts(posts);
        } catch(e) {
            console.error('Error al cargar timeline:', e);
        }
    }
    function mostrarPosts(posts) {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        let postsPublicos = 0;
        posts.forEach(post => {
            console.log('Post contenido:', post.contenido, 'Largo:', post.contenido.length);
            if(post.contenido === '.' || post.contenido === '') {
                console.log('Post saltado (cifrado puro)');
                return;
            }
            postsPublicos++;
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            const idAv = `av-${post.id}`;
            const contenidoProcesado = post.contenido.replace(/#(\w+)/g, '<span style="color: red; font-weight: 600;">#$1</span>');
            const htmlContent = contenidoProcesado.replace(/\n/g, '<br>').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/&lt;br&gt;/g, '<br>').replace(/&lt;span style="color: red; font-weight: 600;"&gt;#/g, '<span style="color: red; font-weight: 600;">#').replace(/#(\w+)&lt;\/span&gt;/g, '#$1</span>');
            const fecha = new Date(post.fecha * 1000);
            const fechaStr = `${fecha.getDate().toString().padStart(2,'0')}/${(fecha.getMonth()+1).toString().padStart(2,'0')}/${fecha.getFullYear()} ${fecha.getHours().toString().padStart(2,'0')}:${fecha.getMinutes().toString().padStart(2,'0')}`;
            postDiv.innerHTML = `
                <div class="avatar" id="${idAv}"></div>
                <div class="post-body">
                    <div class="marca-tag" style="color: ${post.color}">${post.etiqueta}</div>
                    <div class="fecha-tag">${fechaStr}</div>
                    <div style="white-space: pre-wrap; font-size: 15px;">${htmlContent}</div>
                </div>
            `;
            timeline.appendChild(postDiv);
            generateAvatarFromMarca(idAv, post.etiqueta, post.color);
        });
        console.log('Posts públicos mostrados:', postsPublicos);
    }
    async function leerMensajesCifrados() {
        const semilla = document.getElementById('semilla-leer-input').value.trim();
        if(!semilla) {
            alert('Ingresá una semilla para descifrar mensajes');
            return;
        }
        semillaGlobalActiva = semilla;
        try {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            console.log('Posts para descifrar:', posts.length);
            const mensajesDescifrados = [];
            posts.forEach(post => {
                if(!post.contenido_oculto) return;
                try {
                    const bytes = CryptoJS.AES.decrypt(post.contenido_oculto, semilla);
                    const textoDescifrado = bytes.toString(CryptoJS.enc.Utf8);
                    console.log('Texto descifrado:', textoDescifrado, 'Largo:', textoDescifrado.length);
                    if(textoDescifrado && textoDescifrado.length > 0) {
                        mensajesDescifrados.push({
                            id: post.id,
                            etiqueta: post.etiqueta,
                            color: post.color,
                            texto: textoDescifrado,
                            fecha: post.fecha
                        });
                    }
                } catch(e) {
                    console.log('Error descifrando:', e);
                }
            });
            console.log('Mensajes descifrados exitosamente:', mensajesDescifrados.length);
            if(mensajesDescifrados.length === 0) {
                document.getElementById('timeline').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--color-terciario);">No se encontraron mensajes con esta semilla.</div>';
                return;
            }
            mensajesDescifrados.sort((a, b) => a.fecha - b.fecha);
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            mensajesDescifrados.forEach(msg => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                const idAv = `av-${msg.id}`;
                const fecha = new Date(msg.fecha * 1000);
                const fechaStr = `${fecha.getDate().toString().padStart(2,'0')}/${(fecha.getMonth()+1).toString().padStart(2,'0')}/${fecha.getFullYear()} ${fecha.getHours().toString().padStart(2,'0')}:${fecha.getMinutes().toString().padStart(2,'0')}`;
                postDiv.innerHTML = `
                    <div class="avatar" id="${idAv}"></div>
                    <div class="post-body">
                        <div class="marca-tag" style="color: ${msg.color}">${msg.etiqueta}</div>
                        <div class="fecha-tag">${fechaStr}</div>
                        <div style="white-space: pre-wrap; font-size: 15px;">${msg.texto}</div>
                    </div>
                `;
                timeline.appendChild(postDiv);
                generateAvatarFromMarca(idAv, msg.etiqueta, msg.color);
            });
        } catch(e) {
            console.error('Error al descifrar timeline:', e);
        }
    }
    function validarYPostear() {
        const editor = document.getElementById('editor');
        const texto = editor.value.trim();
        if(!texto) {
            alert('Escribí algo antes de postear');
            return;
        }
        postear(texto, null, null);
    }
    async function postearEncriptado() {
        const editor = document.getElementById('editor-encriptado');
        const password = document.getElementById('password-encriptado-input').value.trim();
        const mantenerSemilla = document.getElementById('checkbox-mantener-semilla').checked;
        const texto = editor.value.trim();
        if(!texto) {
            alert('Escribí algo antes de postear');
            return;
        }
        if(!password) {
            alert('La semilla es obligatoria para mensajes cifrados');
            return;
        }
        const palabras = password.split(/\s+/);
        if(palabras.length < 1 || palabras.length > 12) {
            alert('Usá entre 1 y 12 palabras para la semilla');
            return;
        }
        const contenidoCifrado = CryptoJS.AES.encrypt(texto, password).toString();
        console.log('Contenido cifrado:', contenidoCifrado);
        const payload = {
            etiqueta: miMarca,
            contenido: '.',
            color: miColor,
            semilla: null,
            contenido_oculto: contenidoCifrado
        };
        try {
            const res = await fetch('/api/postear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                editor.value = '';
                if(!mantenerSemilla) {
                    document.getElementById('password-encriptado-input').value = '';
                }
                document.getElementById('char-count-encriptado').innerText = "288 caracteres restantes";
                alert('Mensaje cifrado publicado. Ingresá la semilla nuevamente para verlo.');
            } else {
                alert('Error al postear');
            }
        } catch(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        }
    }
    async function postear(textoPublico, textoOculto, password) {
        let contenidoCifrado = null;
        if(textoOculto && password) {
            contenidoCifrado = CryptoJS.AES.encrypt(textoOculto, password).toString();
        }
        const payload = {
            etiqueta: miMarca,
            contenido: textoPublico,
            color: miColor,
            semilla: null,
            contenido_oculto: contenidoCifrado
        };
        try {
            const res = await fetch('/api/postear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                document.getElementById('editor').value = '';
                document.getElementById('char-count').innerText = "576 caracteres restantes";
                if(modoApp === 'publico') {
                    await cargarTimeline();
                }
            } else {
                alert('Error al postear');
            }
        } catch(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        }
    }
    function buscarConDelay() {
        if(modoApp === 'encriptado') return;
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(buscar, 500);
    }
    async function buscar() {
        const query = document.getElementById('search-input').value.trim();
        const btnVolver = document.getElementById('btn-volver');
        const searchInfo = document.getElementById('search-info');
        if(!query) {
            await cargarTimeline();
            btnVolver.classList.add('hidden');
            searchInfo.innerText = '';
            buscando = false;
            return;
        }
        buscando = true;
        btnVolver.classList.remove('hidden');
        try {
            const res = await fetch(`/api/buscar?q=${encodeURIComponent(query)}`);
            const resultados = await res.json();
            todosLosPosts = resultados;
            mostrarPosts(resultados);
            if(resultados.length === 0) {
                searchInfo.innerText = 'No se encontraron resultados';
            } else {
                searchInfo.innerText = `${resultados.length} resultado${resultados.length === 1 ? '' : 's'}`;
            }
        } catch(e) {
            console.error('Error en búsqueda:', e);
            searchInfo.innerText = 'Error al buscar';
        }
    }
    function volverATodos() {
        document.getElementById('search-input').value = '';
        document.getElementById('search-info').innerText = '';
        document.getElementById('btn-volver').classList.add('hidden');
        cargarTimeline();
        buscando = false;
    }
    async function actualizarPosts() {
        if(modoApp === 'publico') {
            await cargarTimeline();
        } else {
            if(semillaGlobalActiva) {
                await leerMensajesCifrados();
            }
        }
    }
    function generateAvatarFromMarca(containerId, marca, colorPrincipal) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const coloresFondo = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', 
            '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
            '#2980b9', '#8e44ad'
        ];
        let hash = 0;
        for(let i = 0; i < marca.length; i++) {
            hash = marca.charCodeAt(i) + ((hash << 5) - hash);
        }
        const colorFondo = coloresFondo[Math.abs(hash) % coloresFondo.length];
        const partes = marca.split('.');
        const letras = (partes[0].substring(0, 2) || 'XX').toUpperCase();
        container.style.backgroundColor = colorFondo;
        container.innerText = letras;
    }
    function manejarCambioCheckboxes() {
        const recordarUsuario = document.getElementById('checkbox-recordar-usuario');
        const recordarPassword = document.getElementById('checkbox-recordar-password');
        const usuarioDisplay = document.getElementById('login-usuario-guardado');
        recordarUsuario.addEventListener('change', function() {
            if(!this.checked) {
                localStorage.removeItem('usuario-guardado');
                usuarioDisplay.classList.add('hidden');
            } else {
                const usuarioGuardado = localStorage.getItem('usuario-guardado');
                if(usuarioGuardado) {
                    usuarioDisplay.classList.remove('hidden');
                }
            }
        });
        recordarPassword.addEventListener('change', function() {
            if(!this.checked) {
                localStorage.removeItem('password-guardado');
            }
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('editor');
        const charCount = document.getElementById('char-count');
        if(editor && charCount) {
            editor.addEventListener('input', function() {
                const restantes = 576 - this.value.length;
                charCount.innerText = `${restantes} caracteres restantes`;
            });
        }
        const editorEncriptado = document.getElementById('editor-encriptado');
        const charCountEncriptado = document.getElementById('char-count-encriptado');
        if(editorEncriptado && charCountEncriptado) {
            editorEncriptado.addEventListener('input', function() {
                const restantes = 288 - this.value.length;
                charCountEncriptado.innerText = `${restantes} caracteres restantes`;
            });
        }
    });
    window.onload = async () => {
        await cargarListaTemas();
        cargarTema();
        verificarSesion();
        actualizarContadorReset();
        setInterval(actualizarContadorReset, 60000);
        manejarCambioCheckboxes();
    };
</script>
</body>
</html>
