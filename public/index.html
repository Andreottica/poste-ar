<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>poste.ar · ciudadela</title>
    <style>
        :root { --rastro-color: #2e7d32; --gris-suave: #ddd; --texto: #1a1a1a; }
        body { font-family: 'Courier New', Courier, monospace; background: #fff; color: var(--texto); margin: 0; display: flex; flex-direction: column; align-items: center; font-size: 15px; }
        
        .container { width: 728px; border-left: 1px solid var(--gris-suave); border-right: 1px solid var(--gris-suave); min-height: 100vh; padding: 20px; box-sizing: border-box; }
        
        header { border-bottom: 1px solid var(--gris-suave); padding-bottom: 15px; margin-bottom: 20px; }
        
        .brand-line { font-weight: bold; font-size: 15px; margin-bottom: 2px; }
        .sub-brand { font-size: 15px; color: #666; }

        .alerta-espacio { color: #666; font-size: 15px; margin: 15px 0; display: block; }

        .nav-status { display: flex; justify-content: space-between; align-items: center; background: #fdfdfd; padding: 10px; border: 1px solid var(--gris-suave); font-size: 15px; margin-top: 15px; }
        
        .search-box { width: 100%; padding: 10px; border: 1px solid var(--gris-suave); font-family: inherit; font-size: 15px; outline: none; box-sizing: border-box; margin-top: 15px; }
        
        .search-info { font-size: 15px; color: #666; margin-top: 10px; text-align: center; }
        
        .avatar { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; color: #fff; flex-shrink: 0; border: 2px solid var(--gris-suave); }

        #manual-box { display: none; background: #fff; border: 1px solid var(--gris-suave); padding: 15px; font-size: 15px; white-space: pre-wrap; margin: 15px 0; }

        textarea { width: 100%; height: 100px; border: 1px solid var(--gris-suave); padding: 10px; font-family: inherit; font-size: 15px; resize: none; outline: none; box-sizing: border-box; }
        
        .btn { cursor: pointer; font-family: inherit; font-weight: bold; border: 1px solid var(--gris-suave); padding: 5px 12px; background: #fff; color: #444; font-size: 15px; }
        .btn-postear { cursor: pointer; background: #000; color: #fff; border: 1px solid #000; padding: 8px 25px; font-size: 15px; }
        .btn-volver { cursor: pointer; background: #f5f5f5; color: #444; border: 1px solid var(--gris-suave); padding: 8px 25px; font-size: 15px; }
        
        .post { display: flex; gap: 20px; border-bottom: 1px solid #eee; padding: 25px 0; align-items: flex-start; }
        .post-body { flex-grow: 1; min-width: 0; }
        .marca-tag { font-size: 15px; font-weight: bold; margin-bottom: 5px; }
        .fecha-tag { font-size: 15px; color: #666; margin-bottom: 8px; }
        
        .oculto-box { margin-top: 10px; font-size: 15px; border: 1px dashed var(--gris-suave); padding: 8px; }
        .contador { font-size: 15px; color: #888; text-align: right; margin-top: 5px; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand-line">poste.ar</div>
        <div class="sub-brand">Sitio anónimo, efímero. Ciudadela, Buenos Aires, Argentina.</div>
        
        <span class="alerta-espacio" id="contador-reset">Reseteo DB: calculando...</span>

        <div class="nav-status">
            <span>Tu Marca: <b id="current-marca" style="color:var(--rastro-color)">...</b></span>
            <div>
                <button class="btn" onclick="reetiquetar()">[ reetiquetar ]</button>
                <button class="btn" onclick="toggleManual()">[ manual ]</button>
            </div>
        </div>

        <input type="text" class="search-box" id="search-input" placeholder="Buscar..." onkeyup="buscarConDelay()">
        <div class="search-info" id="search-info"></div>

        <div id="manual-box"></div>
        
        <div style="margin-top: 20px;">
            <textarea id="editor" maxlength="576" placeholder="Escribe aquí... ((secreto|semilla))"></textarea>
            <div class="contador" id="char-count">576 espacios restantes</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px;">
                <button class="btn-postear" onclick="validarYPostear()">[ postear ]</button>
                <button class="btn-volver hidden" id="btn-volver" onclick="volverATodos()">[ volver ]</button>
                <button class="btn" onclick="window.open('/source')">[ download source ]</button>
            </div>
        </div>
    </header>

    <div id="timeline"></div>
</div>

<script>
    let miMarca = "";
    let miColor = "";
    let buscando = false;
    let timeoutBusqueda = null;

    function generarNomenclador() {
        const silabas = ['ba','be','bi','bo','bu','ca','ce','ci','co','cu','da','de','di','do','du','fa','fe','fi','fo','fu','ga','ge','gi','go','gu','ja','je','ji','jo','ju','ka','ke','ki','ko','ku','la','le','li','lo','lu','ma','me','mi','mo','mu','na','ne','ni','no','nu','pa','pe','pi','po','pu','ra','re','ri','ro','ru','sa','se','si','so','su','ta','te','ti','to','tu','va','ve','vi','vo','vu','xa','xe','xi','xo','xu','ya','ye','yi','yo','yu','za','ze','zi','zo','zu'];
        const s = () => silabas[Math.floor(Math.random() * silabas.length)];
        const n = () => Math.floor(Math.random() * 90 + 10);
        return `${s()}${s()}.${n()}.${s()}${s()}.${n()}`;
    }

    function generateAvatar(containerId) {
        generateAvatarFromMarca(containerId, miMarca, miColor);
    }

    function toggleManual() {
        const box = document.getElementById('manual-box');
        if(box.style.display === 'block') { box.style.display = 'none'; return; }
        fetch('postear.txt').then(r => r.text()).then(t => {
            box.innerText = t;
            box.style.display = 'block';
        });
    }

    function reetiquetar() {
        miMarca = generarNomenclador();
        miColor = `hsl(${Math.floor(Math.random()*360)}, 60%, 45%)`;
        document.documentElement.style.setProperty('--rastro-color', miColor);
        document.getElementById('current-marca').innerText = miMarca;
    }

    document.getElementById('editor').oninput = function() {
        document.getElementById('char-count').innerText = (576 - this.value.length) + " espacios restantes";
    };

    function validarYPostear() {
        const text = document.getElementById('editor').value;
        if(!text) return;
        if (text.includes("((") && (!text.includes("|") || !text.includes("))"))) {
            alert("Error: Use ((texto|semilla)) para ocultar contenido.");
            return;
        }
        postear(text);
    }

    function formatearFecha(timestamp) {
        const fecha = new Date(timestamp);
        const dia = String(fecha.getDate()).padStart(2, '0');
        const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
        const mes = meses[fecha.getMonth()];
        const hora = String(fecha.getHours()).padStart(2, '0');
        const min = String(fecha.getMinutes()).padStart(2, '0');
        return `${dia}-${mes} ${hora}:${min}hs`;
    }

    function calcularProximoLunes() {
        const ahora = new Date();
        const diaSemana = ahora.getDay();
        const diasHastaLunes = diaSemana === 0 ? 1 : (8 - diaSemana);
        const proximoLunes = new Date(ahora);
        proximoLunes.setDate(ahora.getDate() + diasHastaLunes);
        proximoLunes.setHours(0, 0, 0, 0);
        return proximoLunes;
    }

    function actualizarContadorReset() {
        const ahora = new Date();
        const proximoLunes = calcularProximoLunes();
        const diff = proximoLunes - ahora;
        
        const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
        const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        document.getElementById('contador-reset').innerText = `Reseteo DB: ${dias}d ${horas}hs`;
    }

    async function cargarTimeline() {
        try {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            mostrarPosts(posts);
        } catch(e) {
            console.error('Error cargando posts:', e);
        }
    }

    function mostrarPosts(posts) {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        posts.forEach(post => mostrarPost(post));
    }

    function mostrarPost(post) {
        const timeline = document.getElementById('timeline');
        const postDiv = document.createElement('div');
        postDiv.className = 'post';
        
        const tieneOculto = post.contenido_oculto !== null;
        let htmlContent = post.contenido
            .replace(/\*(.*?)\*/g, '<b>$1</b>')
            .replace(/_(.*?)_/g, '<i>$1</i>')
            .replace(/<(.*?):(.*?)>/g, '<a href="http://$2" target="_blank" style="color:blue">$1</a>');
        
        if(tieneOculto) {
            htmlContent += ' <span style="background:#000; color:#000;">█████</span>';
        }

        const idAv = 'av-' + Math.random().toString(36).substring(7);
        const fechaFormateada = formatearFecha(post.fecha);
        
        postDiv.innerHTML = `
            <div class="avatar" id="${idAv}"></div>
            <div class="post-body">
                <div class="marca-tag" style="color:${post.color}">${post.etiqueta}</div>
                <div class="fecha-tag">${fechaFormateada}</div>
                <div style="white-space: pre-wrap; font-size: 15px;">${htmlContent}</div>
                ${tieneOculto ? `
                    <div class="oculto-box">
                        Contenido oculto [x]: 
                        <input type="text" placeholder="semilla..." style="border:none; border-bottom:1px solid #ddd; outline:none; width:120px; font-family:inherit; font-size:15px;">
                    </div>` : ''}
            </div>
        `;
        timeline.appendChild(postDiv);
        generateAvatarFromMarca(idAv, post.etiqueta, post.color);
    }

    function buscarConDelay() {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(buscar, 500);
    }

    async function buscar() {
        const query = document.getElementById('search-input').value.trim();
        const btnVolver = document.getElementById('btn-volver');
        const searchInfo = document.getElementById('search-info');
        
        if(!query) {
            await cargarTimeline();
            btnVolver.classList.add('hidden');
            searchInfo.innerText = '';
            buscando = false;
            return;
        }

        buscando = true;
        btnVolver.classList.remove('hidden');

        try {
            const res = await fetch(`/api/buscar?q=${encodeURIComponent(query)}`);
            const resultados = await res.json();
            
            mostrarPosts(resultados);
            
            if(resultados.length === 0) {
                searchInfo.innerText = 'No se encontraron resultados';
            } else {
                searchInfo.innerText = `${resultados.length} resultado${resultados.length === 1 ? '' : 's'}`;
            }
        } catch(e) {
            console.error('Error en búsqueda:', e);
            searchInfo.innerText = 'Error al buscar';
        }
    }

    function volverATodos() {
        document.getElementById('search-input').value = '';
        document.getElementById('search-info').innerText = '';
        document.getElementById('btn-volver').classList.add('hidden');
        cargarTimeline();
        buscando = false;
    }

    async function postear(text) {
        const payload = {
            etiqueta: miMarca,
            contenido: text,
            color: miColor,
            semilla: null,
            contenido_oculto: null
        };
        
        try {
            const res = await fetch('/api/postear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if(res.ok) {
                document.getElementById('editor').value = '';
                document.getElementById('char-count').innerText = "576 espacios restantes";
                await cargarTimeline();
            } else {
                alert('Error al postear');
            }
        } catch(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        }
    }

    function generateAvatarFromMarca(containerId, marca, colorPrincipal) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        const coloresFondo = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', 
            '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
            '#2980b9', '#8e44ad'
        ];
        
        let hash = 0;
        for(let i = 0; i < marca.length; i++) {
            hash = marca.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const colorFondo = coloresFondo[Math.abs(hash) % coloresFondo.length];
        
        const partes = marca.split('.');
        const letras = (partes[0].substring(0, 2) || 'XX').toUpperCase();
        
        container.style.backgroundColor = colorFondo;
        container.innerText = letras;
    }

    window.onload = () => {
        reetiquetar();
        cargarTimeline();
        actualizarContadorReset();
        setInterval(actualizarContadorReset, 60000);
    };
</script>
</body>
</html>
