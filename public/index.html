<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>poste.ar | Ciudadela</title>
    <style>
        body { background-color: #000; color: #fff; font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Barra Superior */
        header { border-bottom: 1px solid #333; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        #capacidad { color: #0ff; font-weight: bold; }
        #buscador { background: #000; border: 1px solid #444; color: #0ff; padding: 4px; width: 120px; outline: none; font-size: 0.8em; }

        /* Timeline */
        #timeline { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        /* Posteo con Estilo Original */
        .post { border-left: 3px solid; padding-left: 15px; position: relative; }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 5px; font-size: 0.9em; }
        
        /* Avatar 3x3 Mejorado: Más cuadradito y vibrante */
        .avatar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; width: 27px; height: 27px; background: #222; border: 1px solid #444; }
        .pixel { width: 100%; height: 100%; }

        /* Consola Inferior (Tu diseño original) */
        footer { height: 120px; display: flex; border-top: 1px solid #333; background: #050505; }
        
        .menu-lat { width: 60px; border-right: 1px solid #333; display: flex; flex-direction: column; justify-content: space-around; align-items: center; font-size: 0.7em; }
        .menu-lat a { color: #555; text-decoration: none; writing-mode: vertical-lr; transform: rotate(180deg); }

        .input-area { flex: 1; display: flex; flex-direction: column; padding: 10px; }
        #etiqueta { background: #000; border: 1px solid #333; color: #0ff; width: 80px; margin-bottom: 5px; padding: 2px 5px; }
        #mensaje { flex: 1; background: #000; color: #fff; border: none; outline: none; resize: none; font-family: monospace; font-size: 1.1em; }

        .btn-pub { width: 100px; background: #00ffcc; border: none; color: #000; font-weight: bold; cursor: pointer; font-size: 1em; transition: 0.2s; }
        .btn-pub:hover { background: #fff; }

        /* Texto secreto */
        .secreto { background: #222; color: #222; cursor: pointer; padding: 0 4px; border-radius: 2px; }
        .secreto:hover { background: #333; }
    </style>
</head>
<body>

<header>
    <div>POSTE.AR <span id="capacidad">--%</span></div>
    <input type="text" id="buscador" placeholder="Buscar etiqueta...">
</header>

<main id="timeline">
    </main>

<footer>
    <div class="menu-lat">
        <a href="postear.txt" target="_blank">MANUAL</a>
        <a href="source.txt" target="_blank">SOURCE</a>
    </div>
    
    <div class="input-area">
        <input type="text" id="etiqueta" placeholder="#etiqueta">
        <textarea id="mensaje" placeholder="Escribe aquí... usa [ ] para secretos"></textarea>
    </div>

    <button class="btn-pub" onclick="enviarPosteo()">PUBLICAR</button>
</footer>

<script>
    const API_URL = window.location.origin;

    // Generador Silábico (ej: fuso.padi)
    function generarSemilla() {
        const c = "bdfghjklmnprstvz";
        const v = "aeiou";
        const s = () => c[Math.floor(Math.random()*c.length)] + v[Math.floor(Math.random()*v.length)];
        return `${s()}${s()}.${s()}${s()}`;
    }

    function crearAvatar(semilla, colorBase) {
        const hash = semilla.split('').reduce((a,b) => a + b.charCodeAt(0), 0);
        let html = `<div class="avatar">`;
        for(let i=0; i<9; i++) {
            const color = (hash + i) % 3 === 0 ? colorBase : ( (hash+i)%3 === 1 ? '#fff' : '#000');
            html += `<div class="pixel" style="background:${color}; filter: saturate(2.5) contrast(1.2);"></div>`;
        }
        return html + `</div>`;
    }

    async function cargarPosteos() {
        try {
            const res = await fetch(`${API_URL}/api/posts`);
            const posts = await res.json();
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            document.getElementById('capacidad').innerText = Math.round((posts.length / 576) * 100) + '%';

            posts.forEach(p => {
                const div = document.createElement('div');
                div.className = 'post';
                div.style.borderColor = p.color;
                div.innerHTML = `
                    <div class="post-header">
                        ${crearAvatar(p.semilla, p.color)}
                        <span style="color:#666">${p.semilla}</span>
                        <span style="color:${p.color}">#${p.etiqueta}</span>
                    </div>
                    <div class="post-content">${p.contenido.replace(/\[(.*?)\]/g, '<span class="secreto" onclick="this.style.color=\'#fff\'">$1</span>')}</div>
                `;
                timeline.appendChild(div);
            });
        } catch (e) { console.error("Error cargando base de datos"); }
    }

    async function enviarPosteo() {
        const etiqueta = document.getElementById('etiqueta').value || 'general';
        const contenido = document.getElementById('mensaje').value;
        if(!contenido) return;

        const data = {
            etiqueta,
            contenido,
            color: `hsl(${Math.random()*360}, 80%, 60%)`,
            semilla: generarSemilla()
        };

        await fetch(`${API_URL}/api/postear`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        document.getElementById('mensaje').value = '';
        cargarPosteos();
    }

    document.getElementById('buscador').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.post').forEach(p => {
            p.style.display = p.innerText.toLowerCase().includes(term) ? 'block' : 'none';
        });
    });

    setInterval(cargarPosteos, 15000);
    cargarPosteos();
</script>
</body>
</html>
