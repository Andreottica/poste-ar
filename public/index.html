<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>poste.ar · ciudadela</title>
    <meta name="description" content="Red social anónima con mensajes públicos y secretos criptografiados (AES-256). Sin usuarios, sin IPs, sin contraseñas guardadas. Todo se borra cada lunes. Cada mensaje oculto tiene su password único, si lo perdés, perdés el mensaje.">
    <meta name="keywords" content="red social anónima, mensajes criptografiados, cifrado AES-256, comunicación anónima, poste.ar, Ciudadela">
    <meta name="author" content="poste.ar">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://poste.ar/">
    <meta property="og:title" content="poste.ar · ciudadela">
    <meta property="og:description" content="Red social anónima con mensajes públicos y secretos criptografiados (AES-256). Sin usuarios, sin IPs, sin contraseñas guardadas. Todo se borra cada lunes. Cada mensaje oculto tiene su password único, si lo perdés, perdés el mensaje.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://poste.ar/">
    <meta property="twitter:title" content="poste.ar · ciudadela">
    <meta property="twitter:description" content="Red social anónima con mensajes públicos y secretos criptografiados (AES-256). Sin usuarios, sin IPs, sin contraseñas guardadas. Todo se borra cada lunes. Cada mensaje oculto tiene su password único, si lo perdés, perdés el mensaje.">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" id="theme-stylesheet" href="themes/default.css">
    <link rel="stylesheet" href="themes/mobile.css">
    <style>
        /* Estilos base que no interfieren con mobile/theme CSS */
        .header-profile { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; }
        .header-profile img { width: 60px; height: 60px; flex-shrink: 0; }
        .header-profile-info { flex: 1; }
        
        .button-container { display: flex; justify-content: space-between; gap: 10px; margin-top: 15px; }
        .button-group { display: flex; gap: 10px; }
        
        /* Hover effect for web version */
        @media (hover: hover) {
            /* Soft gray hover for regular buttons */
            .btn:hover, .btn-volver:hover {
                background: rgba(0, 0, 0, 0.05) !important;
                transition: background 0.2s ease;
            }
            
            body.modo-noche .btn:hover,
            body.modo-noche .btn-volver:hover {
                background: rgba(255, 255, 255, 0.08) !important;
            }
            
            /* Postear button - brightness effect */
            .btn-postear:hover {
                filter: brightness(1.1);
                transition: filter 0.2s ease;
            }
            
            /* Dark mode: postear button turns soft gray */
            body.modo-noche .btn-postear:hover {
                background: rgba(128, 128, 128, 0.3) !important;
                filter: none;
            }
        }
        
        .editor-section { margin-top: 20px; }
        .checkbox-label { cursor: pointer; font-size: 15px; }
        .checkbox-container { margin-top: 10px; }
        
        .password-section { margin-top: 10px; }
        .password-label { font-size: 15px; color: var(--color-secundario); margin-bottom: 5px; }
        .password-hint { font-size: 13px; color: var(--color-terciario); margin-top: 5px; }
        
        .bottom-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-profile">
            <img src="postear.gif" alt="logo">
            <div class="header-profile-info">
                <div class="brand-line">poste.ar</div>
                <div class="sub-brand">Sitio anónimo, efímero. Ciudadela, Buenos Aires, Argentina.</div>
            </div>
        </div>

        <div class="alerta-box" id="contador-reset">El timeline se borra todos los lunes: calculando...</div>

        <div class="nav-status">
            <span>Etiqueta: <b id="current-marca" style="color:var(--rastro-color)">...</b></span>
        </div>

        <div class="button-container">
            <button class="btn" onclick="reetiquetar()">[ reetiquetar ]</button>
            <button class="btn" onclick="toggleDiaNoche()" id="btn-modo">[ día ]</button>
            <button class="btn" onclick="toggleManual()">[ manual ]</button>
            <button class="btn" onclick="cambiarTema()" id="btn-tema">[ default ]</button>
            <button class="btn" onclick="window.open('/source')">[ source ]</button>
        </div>

        <input type="text" class="search-box" id="search-input" placeholder="Buscar..." onkeyup="buscarConDelay()">
        <div class="search-info" id="search-info"></div>
        <button class="btn-volver hidden" id="btn-volver" onclick="volverATodos()">[ volver ]</button>

        <div id="manual-box"></div>
        
        <div class="editor-section">
            <textarea id="editor" maxlength="576" placeholder="Mensaje público..."></textarea>
            <div class="contador" id="char-count">576 caracteres restantes</div>
            
            <div class="checkbox-container">
                <label class="checkbox-label">
                    <input type="checkbox" id="checkbox-oculto" onchange="toggleOculto()"> Agregar mensaje oculto cifrado
                </label>
            </div>
            
            <div class="oculto-section" id="oculto-section">
                <textarea id="editor-oculto" maxlength="288" placeholder="Mensaje oculto (288 caracteres)..."></textarea>
                <div class="contador" id="char-count-oculto">288 caracteres restantes</div>
                
                <div class="password-section">
                    <div class="password-label">Password (obligatorio):</div>
                    <input type="text" id="password-input" placeholder="Ejemplo: perro tiza golf maria" class="password-input">
                    <div class="password-hint">1-12 palabras. Más palabras = más seguridad.</div>
                </div>
            </div>

            <div class="button-container button-container-bottom">
                <button class="btn-postear" onclick="validarYPostear()">[ postear ]</button>
                <button class="btn" onclick="actualizarPosts()">[ actualizar ]</button>
            </div>
        </div>
    </header>

    <div id="timeline"></div>
</div>

<script>
    let miMarca = "";
    let miColor = "";
    let buscando = false;
    let timeoutBusqueda = null;
    
    let temas = ['default', 'retro', 'minimo', 'ascii']; // Lista de temas disponibles
    let temaActual = localStorage.getItem('tema') || 'default';
    let modoOscuro = localStorage.getItem('modo') === 'noche';

    // Función para cargar temas desde servidor (opcional, usa fallback si falla)
    async function cargarListaTemas() {
        try {
            const response = await fetch('/api/temas');
            if (response.ok) {
                const temasDisponibles = await response.json();
                // Filtrar para excluir mobile.css
                const temasFiltrados = temasDisponibles.filter(t => t !== 'mobile');
                if (temasFiltrados.length > 0) {
                    temas = temasFiltrados;
                }
            }
        } catch(e) {
            // Usar lista hardcodeada si no hay endpoint
            console.log('Usando lista de temas por defecto');
        }
        
        // Validar que el tema actual existe
        if (!temas.includes(temaActual)) {
            temaActual = 'default';
            localStorage.setItem('tema', temaActual);
        }
    }

    function cargarTema() {
        const link = document.getElementById('theme-stylesheet');
        link.href = `themes/${temaActual}.css`;
        const btnTema = document.getElementById('btn-tema');
        if(btnTema) {
            btnTema.innerText = `[ ${temaActual} ]`;
        }
        
        if(modoOscuro) {
            document.body.classList.add('modo-noche');
            document.getElementById('btn-modo').innerText = '[ noche ]';
        } else {
            document.body.classList.remove('modo-noche');
            document.getElementById('btn-modo').innerText = '[ día ]';
        }
    }

    function cambiarTema() {
        const indiceActual = temas.indexOf(temaActual);
        const siguienteIndice = (indiceActual + 1) % temas.length;
        temaActual = temas[siguienteIndice];
        localStorage.setItem('tema', temaActual);
        cargarTema();
    }

    function toggleDiaNoche() {
        modoOscuro = !modoOscuro;
        localStorage.setItem('modo', modoOscuro ? 'noche' : 'dia');
        cargarTema();
    }

    function generarNomenclador() {
        const silabas = ['ba','be','bi','bo','bu','ca','ce','ci','co','cu','da','de','di','do','du','fa','fe','fi','fo','fu','ga','ge','gi','go','gu','ja','je','ji','jo','ju','ka','ke','ki','ko','ku','la','le','li','lo','lu','ma','me','mi','mo','mu','na','ne','ni','no','nu','pa','pe','pi','po','pu','ra','re','ri','ro','ru','sa','se','si','so','su','ta','te','ti','to','tu','va','ve','vi','vo','vu','xa','xe','xi','xo','xu','ya','ye','yi','yo','yu','za','ze','zi','zo','zu'];
        const s = () => silabas[Math.floor(Math.random() * silabas.length)];
        const n = () => Math.floor(Math.random() * 90 + 10);
        return `${s()}${s()}.${n()}.${s()}${s()}.${n()}`;
    }

    function toggleOculto() {
        const checkbox = document.getElementById('checkbox-oculto');
        const section = document.getElementById('oculto-section');
        section.style.display = checkbox.checked ? 'block' : 'none';
    }

    function toggleManual() {
        const box = document.getElementById('manual-box');
        if(box.style.display === 'block') { box.style.display = 'none'; return; }
        fetch('postear.txt').then(r => r.text()).then(t => {
            box.innerText = t;
            box.style.display = 'block';
        });
    }

    function reetiquetar() {
        miMarca = generarNomenclador();
        miColor = `hsl(${Math.floor(Math.random()*360)}, 60%, 45%)`;
        document.documentElement.style.setProperty('--rastro-color', miColor);
        document.getElementById('current-marca').innerText = miMarca;
    }

    document.getElementById('editor').oninput = function() {
        document.getElementById('char-count').innerText = (576 - this.value.length) + " caracteres restantes";
    };

    document.getElementById('editor-oculto').oninput = function() {
        document.getElementById('char-count-oculto').innerText = (288 - this.value.length) + " caracteres restantes";
    };

    function validarYPostear() {
        const textoPublico = document.getElementById('editor').value;
        const checkboxOculto = document.getElementById('checkbox-oculto').checked;
        const textoOculto = document.getElementById('editor-oculto').value;
        const password = document.getElementById('password-input').value.trim();
        
        if(!textoPublico && !textoOculto) {
            alert("Escribe al menos un mensaje (público u oculto).");
            return;
        }
        
        if(checkboxOculto && textoOculto && !password) {
            alert("⚠️ Falta password para el mensaje oculto");
            return;
        }
        
        postear(textoPublico, textoOculto, password);
    }

    function formatearFecha(timestamp) {
        const fecha = new Date(timestamp);
        const dia = String(fecha.getDate()).padStart(2, '0');
        const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
        const mes = meses[fecha.getMonth()];
        const hora = String(fecha.getHours()).padStart(2, '0');
        const min = String(fecha.getMinutes()).padStart(2, '0');
        return `${dia}-${mes} ${hora}:${min}hs`;
    }

    function calcularProximoLunes() {
        const ahora = new Date();
        const diaSemana = ahora.getDay();
        const diasHastaLunes = diaSemana === 0 ? 1 : (8 - diaSemana);
        const proximoLunes = new Date(ahora);
        proximoLunes.setDate(ahora.getDate() + diasHastaLunes);
        proximoLunes.setHours(0, 0, 0, 0);
        return proximoLunes;
    }

    function actualizarContadorReset() {
        const ahora = new Date();
        const proximoLunes = calcularProximoLunes();
        const diff = proximoLunes - ahora;
        
        const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
        const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        document.getElementById('contador-reset').innerText = `El timeline se borra todos los lunes: faltan ${dias}d ${horas}h ${minutos}m`;
    }

    async function cargarTimeline() {
        try {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            mostrarPosts(posts);
        } catch(e) {
            console.error('Error cargando posts:', e);
        }
    }

    function mostrarPosts(posts) {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';
        posts.forEach(post => mostrarPost(post));
    }

    function mostrarPost(post) {
        const timeline = document.getElementById('timeline');
        const postDiv = document.createElement('div');
        postDiv.className = 'post';
        
        // Escapar HTML primero para seguridad
        let htmlContent = post.contenido
            // Links con https:// o http://
            .replace(/<([^<>]+?):(https?:\/\/[^<>\s]+)>/g, '<a href="$2" target="_blank">$1</a>')
            // Links sin protocolo (solo www. o dominio)
            .replace(/<([^<>]+?):(?!\/\/)([^<>\s]+)>/g, '<a href="http://$2" target="_blank">$1</a>')
            // Etiquetas formato palabra.numero.palabra.numero
            .replace(/\b([a-z]+\.\d+\.[a-z]+\.\d+)\b/gi, '<span style="color: #2e7d32; font-weight: bold;">$1</span>')
            // Negritas
            .replace(/\*([^\*]+)\*/g, '<b>$1</b>')
            // Itálicas
            .replace(/_(.*?)_/g, '<i>$1</i>')
            // Hashtags
            .replace(/#(\w+)/g, '<span style="color: #d32f2f; font-weight: bold;">#$1</span>')
            // Saltos de línea
            .replace(/\n/g, '<br>');

        const idAv = 'av-' + Math.random().toString(36).substring(7);
        const idSemilla = 'semilla-' + Math.random().toString(36).substring(7);
        const idOculto = 'oculto-' + Math.random().toString(36).substring(7);
        const fechaFormateada = formatearFecha(post.fecha);
        
        postDiv.innerHTML = `
            <div class="avatar" id="${idAv}"></div>
            <div class="post-body">
                <div class="marca-tag" style="color:${post.color}">${post.etiqueta}</div>
                <div class="fecha-tag">${fechaFormateada}</div>
                <div style="white-space: pre-wrap; font-size: 15px;">${htmlContent}</div>
                <div class="semilla-box">
                    <input type="text" class="semilla-input" id="${idSemilla}" placeholder="semilla..." onkeypress="if(event.key==='Enter') descifrarMensaje('${idSemilla}', '${idOculto}', '${post.contenido_oculto || ''}')">
                    <button class="semilla-btn" onclick="descifrarMensaje('${idSemilla}', '${idOculto}', '${post.contenido_oculto || ''}')">→</button>
                </div>
                <div id="${idOculto}"></div>
            </div>
        `;
        timeline.appendChild(postDiv);
        generateAvatarFromMarca(idAv, post.etiqueta, post.color);
    }

    function descifrarMensaje(idSemilla, idOculto, contenidoCifrado) {
        const inputSemilla = document.getElementById(idSemilla);
        const divOculto = document.getElementById(idOculto);
        const semilla = inputSemilla.value.trim();
        
        if(!semilla) return;
        if(!contenidoCifrado) {
            divOculto.innerHTML = '';
            return;
        }
        
        try {
            const bytes = CryptoJS.AES.decrypt(contenidoCifrado, semilla);
            const textoDescifrado = bytes.toString(CryptoJS.enc.Utf8);
            
            if(textoDescifrado) {
                divOculto.innerHTML = `<div class="mensaje-oculto">${textoDescifrado}</div>`;
            } else {
                divOculto.innerHTML = '<div class="mensaje-error">Password incorrecto</div>';
            }
        } catch(e) {
            divOculto.innerHTML = '<div class="mensaje-error">Password incorrecto</div>';
        }
    }

    function buscarConDelay() {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(buscar, 500);
    }

    async function buscar() {
        const query = document.getElementById('search-input').value.trim();
        const btnVolver = document.getElementById('btn-volver');
        const searchInfo = document.getElementById('search-info');
        
        if(!query) {
            await cargarTimeline();
            btnVolver.classList.add('hidden');
            searchInfo.innerText = '';
            buscando = false;
            return;
        }

        buscando = true;
        btnVolver.classList.remove('hidden');

        try {
            const res = await fetch(`/api/buscar?q=${encodeURIComponent(query)}`);
            const resultados = await res.json();
            
            mostrarPosts(resultados);
            
            if(resultados.length === 0) {
                searchInfo.innerText = 'No se encontraron resultados';
            } else {
                searchInfo.innerText = `${resultados.length} resultado${resultados.length === 1 ? '' : 's'}`;
            }
        } catch(e) {
            console.error('Error en búsqueda:', e);
            searchInfo.innerText = 'Error al buscar';
        }
    }

    function volverATodos() {
        document.getElementById('search-input').value = '';
        document.getElementById('search-info').innerText = '';
        document.getElementById('btn-volver').classList.add('hidden');
        cargarTimeline();
        buscando = false;
    }

    async function actualizarPosts() {
        await cargarTimeline();
    }

    async function postear(textoPublico, textoOculto, password) {
        let contenidoCifrado = null;
        
        if(textoOculto && password) {
            contenidoCifrado = CryptoJS.AES.encrypt(textoOculto, password).toString();
        }
        
        const payload = {
            etiqueta: miMarca,
            contenido: textoPublico,
            color: miColor,
            semilla: null,
            contenido_oculto: contenidoCifrado
        };
        
        try {
            const res = await fetch('/api/postear', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if(res.ok) {
                document.getElementById('editor').value = '';
                document.getElementById('editor-oculto').value = '';
                document.getElementById('password-input').value = '';
                document.getElementById('checkbox-oculto').checked = false;
                document.getElementById('oculto-section').style.display = 'none';
                document.getElementById('char-count').innerText = "576 caracteres restantes";
                document.getElementById('char-count-oculto').innerText = "288 caracteres restantes";
                await cargarTimeline();
            } else {
                alert('Error al postear');
            }
        } catch(e) {
            console.error('Error:', e);
            alert('Error de conexión');
        }
    }

    function generateAvatarFromMarca(containerId, marca, colorPrincipal) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        const coloresFondo = [
            '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', 
            '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
            '#2980b9', '#8e44ad'
        ];
        
        let hash = 0;
        for(let i = 0; i < marca.length; i++) {
            hash = marca.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const colorFondo = coloresFondo[Math.abs(hash) % coloresFondo.length];
        
        const partes = marca.split('.');
        const letras = (partes[0].substring(0, 2) || 'XX').toUpperCase();
        
        container.style.backgroundColor = colorFondo;
        container.innerText = letras;
    }

    window.onload = async () => {
        await cargarListaTemas();
        cargarTema();
        reetiquetar();
        cargarTimeline();
        actualizarContadorReset();
        setInterval(actualizarContadorReset, 60000);
    };
</script>
</body>
</html>
